<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="text-success">
    <i class="fa fa-dollar-sign me-2"></i>Manajemen Billing
  </h4>
</div>
<!-- Statistik Saldo -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="stat-card">
      <h5>Saldo Tersedia</h5>
      <h2>Rp 0</h2>
      <small>Update terakhir: 0</small>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <h5>Pemakaian</h5>
      <h2>Rp 0</h2>
      <small>Bulan Ini</small>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <h5>Belum Terbayar</h5>
      <h2>0 Pending</h2>
      <small>Jatuh tempo 1x24 jam</small>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-12">
    <div class="stat-card">
      <h5 class="mb-4"><i class="fa fa-history me-2"></i>Riwayat Transaksi</h5>
      <!-- Tabs -->

      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a class="nav-link active filter-btn" data-status="all" href="#"
            >Semua</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link filter-btn" data-status="pending" href="#"
            >Pending</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link filter-btn" data-status="success" href="#"
            >Success</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link filter-btn" data-status="paid" href="#">Paid</a>
        </li>
        <li class="nav-item">
          <a class="nav-link filter-btn" data-status="failed" href="#"
            >Failed</a
          >
        </li>
      </ul>

      <!-- Tabel Transaksi -->
      <table class="table table-striped table-hover" id="transaksiTable">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Deskripsi</th>
            <th>Jumlah</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    function loadBillingData(status = "all") {
      $.ajax({
        url: "/admin/billing/data",
        method: "GET",
        data: { status },
        success: function (response) {
          if (!response.success) return alert("Gagal memuat transaksi");
          const { transactions, balance, totalUsed, totalPending } =
            response.data;

          // Update saldo dan pemakaian
          $(".stat-card:eq(0) h2").text(`Rp ${balance.toLocaleString()}`);
          $(".stat-card:eq(1) h2").text(`Rp ${totalUsed.toLocaleString()}`);
          $(".stat-card:eq(2) h2").text(`${totalPending} Pending`);

          const tbody = $("#transaksiTable tbody");
          tbody.empty();

          if (transactions.length === 0) {
            tbody.append(
              `<tr><td colspan="5" class="text-center">Tidak ada transaksi</td></tr>`
            );
            return;
          }

          $.each(transactions, function (_, tx) {
            const badge = getStatusBadge(tx.status);
            tbody.append(`
              <tr>
                <td>${tx.formattedDate}</td>
                <td>${tx.description}</td>
                <td>${tx.amountFormatted}</td>
                <td>${badge}</td>
              </tr>`);
          });
        },
        error: function (err) {
          console.error(err);
          alert("Gagal mengambil data billing.");
        },
      });
    }

    function getStatusBadge(status) {
      const map = {
        success: "bg-success",
        paid: "bg-primary",
        failed: "bg-danger",
        pending: "bg-warning text-dark",
      };
      return `<span class="badge ${
        map[status] || "bg-secondary"
      }">${status}</span>`;
    }

    // Tombol filter tab
    $(".filter-btn").on("click", function () {
      $(".filter-btn").removeClass("active");
      $(this).addClass("active");
      const status = $(this).data("status");
      loadBillingData(status);
    });
    // Initial load
    loadBillingData("all");
  });
</script>
