<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="text-success">
    <i class="fa fa-comment me-2"></i>Manajemen Pesan
  </h4>
</div>

<!-- Statistik Pesan -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <h5>Total Pesan Dikirim</h5>
      <h2 class="text-success" id="totalSent">0/0</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <h5>Pesan Tertunda</h5>
      <h2 class="text-secondary" id="pendingCount">0</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <h5>Pesan Diproses</h5>
      <h2 class="text-warning" id="processingCount">0</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <h5>Pesan Gagal</h5>
      <h2 class="text-danger" id="failedCount">0</h2>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="stat-card">
      <h5 class="mb-4"><i class="fa fa-envelope me-2"></i>Daftar Pesan</h5>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a
            class="nav-link active"
            href="#"
            data-status="all"
            onclick="setActiveTab(this)"
            >Semua</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="#"
            data-status="pending"
            onclick="setActiveTab(this)"
            >Pending</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="#"
            data-status="processing"
            onclick="setActiveTab(this)"
            >Processing</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="#"
            data-status="sent"
            onclick="setActiveTab(this)"
            >Sent</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="#"
            data-status="failed"
            onclick="setActiveTab(this)"
            >Failed</a
          >
        </li>
      </ul>
      <div class="row mb-3">
        <div class="col-md-12">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Cari Nomor Tujuan, Isi Pesan, Tipe, atau Status..."
            onkeyup="filterPesan()"
          />
        </div>
      </div>

      <!-- Tabel Pesan -->
      <table class="table table-striped table-hover" id="pesanTable">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Nomor Tujuan</th>
            <th>Isi Pesan</th>
            <th>Tipe</th>
            <th>Status</th>
            <th style="width: 100px">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pagination" class="d-flex justify-content-center mt-3"></div>
    </div>
  </div>
</div>

<!-- Floating Button -->
<button
  class="floating-button"
  data-bs-toggle="modal"
  data-bs-target="#formKirimPesan"
>
  <i class="fas fa-plus"></i>
</button>

<!-- Form Dialog Kirim Pesan -->
<div id="formKirimPesan" class="modal" style="display: none">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="sendMessageForm">
        <div class="modal-header">
          <h5 class="modal-title">Kirim Pesan</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Perangkat</label>
            <select id="device" class="form-control">
              <% devices.forEach(device=> { %>
              <option value="<%= device.device_key %>">
                <%= device.name %> (<%= device.phone %> - <%= device.device_key
                %>)
              </option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Tipe Pesan:</label>
            <select id="group" class="form-control" required>
              <option value="false">Pribadi</option>
              <option value="true">Grup</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tujuan:</label>
            <input
              type="text"
              id="to"
              class="form-control"
              placeholder="Nomor telepon atau ID grup (pisahkan dengan koma)"
              required
            />
          </div>
          <div class="form-group">
            <label>Isi Pesan:</label>
            <textarea
              id="text"
              class="form-control"
              rows="4"
              placeholder="Tulis pesan Anda..."
              required
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <a class="btn btn-secondary" data-bs-dismiss="modal">Batalkan</a>
          <button id="sendMessageButton" class="btn btn-success" type="submit">
            Kirim
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<input type="hidden" id="apiKey" value="<%= apiKey %>" />
<input type="hidden" id="tabActive" value="all" />

<!-- Pastikan Moment.js sudah tersedia -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
  let refreshInterval; // Variabel untuk menyimpan interval

  let currentPage = 1;
  const limit = 30;

  function setActiveTab(element, status) {
    document
      .querySelectorAll(".nav-tabs .nav-link")
      .forEach((tab) => tab.classList.remove("active"));
    element.classList.add("active");

    const activeTab = document.querySelector(".nav-tabs .nav-link.active");
    const activeStatus = activeTab
      ? activeTab.getAttribute("data-status")
      : "all";

    $("#tabActive").val(activeStatus);

    filterPesan();
  }

  async function filterPesan(page = 1) {
    try {
      const activeStatus = $("#tabActive").val();

      const searchKeyword = document
        .getElementById("searchInput")
        .value.toLowerCase();
      const response = await fetch(
        `/client/message/data?status=${activeStatus}&page=${page}&limit=${limit}`
      );
      const data = await response.json();
      if (!data.success) {
        console.error("Gagal mengambil data pesan.");
        return;
      }
      const tbody = document.querySelector("#pesanTable tbody");
      tbody.innerHTML = "";

      if (data.messages.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="6" class="text-center">Tidak ada pesan terdaftar</td></tr>';
      } else {
        data.messages.forEach((message) => {
          const statusClass =
            {
              processing: "warning",
              sent: "success",
              failed: "danger",
              pending: "secondary",
            }[message.status] || "default";

          const formattedTime = moment(
            message.updated_at || message.created_at
          ).format("YYYY/MM/DD HH:mm");
          const row = `
          <tr data-status="${message.status}">
            <td>${formattedTime}</td>
            <td>${message.number} - ${message.device_key}</td>
            <td>${message.message}</td>
            <td>${message.type}</td>
            <td><span class="badge bg-${statusClass}">${message.status}</span></td>
            <td>
              <button class="btn btn-sm btn-secondary btn-action" onclick="confirmRetry('${message.id}')">
                <i class="fa fa-undo"></i>
              </button>
              <button class="btn btn-sm btn-danger btn-action" onclick="confirmDelete('${message.id}')">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>`;
          tbody.innerHTML += row;
        });
      }

      // Update statistik
      document.getElementById(
        "totalSent"
      ).innerText = `${data.counts.sent}/${data.counts.totalCount}`;
      document.getElementById("pendingCount").innerText = data.counts.pending;
      document.getElementById("processingCount").innerText =
        data.counts.processing;
      document.getElementById("failedCount").innerText = data.counts.failed;

      // Pagination render
      renderPagination(data.pagination, status);
    } catch (error) {
      console.error("Error fetching messages:", error);
    }
  }

  function renderPagination(pagination, status) {
    const container = document.getElementById("pagination");
    container.innerHTML = "";

    if (pagination.totalPages <= 1) return;

    let html = `<nav><ul class="pagination">`;

    // Prev
    if (pagination.page > 1) {
      html += `<li class="page-item"><a class="page-link" href="#" onclick="filterPesan(${
        pagination.page - 1
      })">«</a></li>`;
    }

    // Numbered pages
    for (let i = 1; i <= pagination.totalPages; i++) {
      html += `<li class="page-item ${i === pagination.page ? "active" : ""}">
      <a class="page-link" href="#" onclick="filterPesan(${i})">${i}</a>
    </li>`;
    }

    // Next
    if (pagination.page < pagination.totalPages) {
      html += `<li class="page-item"><a class="page-link" href="#" onclick="filterPesan(${
        pagination.page + 1
      })">»</a></li>`;
    }

    html += `</ul></nav>`;
    container.innerHTML = html;
  }

  document.addEventListener("DOMContentLoaded", function () {
    filterPesan();
  });

  function toggleAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById("autoRefreshCheckbox");
    if (autoRefreshCheckbox.checked) {
      startAutoRefresh();
    } else {
      stopAutoRefresh();
    }
  }

  function startAutoRefresh() {
    refreshInterval = setInterval(() => {
      filterPesan(); // Panggil filterPesan berdasarkan tab yang aktif
    }, 15000); // 15 detik
  }

  function stopAutoRefresh() {
    clearInterval(refreshInterval);
  }

  $("#sendMessageForm").submit(async function (event) {
    event.preventDefault();
    const apiKey = $("#apiKey").val();
    const deviceKey = $("#device").val();
    const to = $("#to").val().trim();
    const text = $("#text").val().trim();
    const group = $("#group").val() === "true";
    const sendMessageButton = document.getElementById("sendMessageButton");

    if (!deviceKey || !to || !text) {
      showToast("Semua field harus diisi!", "danger");
      return;
    }
    // Disable tombol dan ubah teks jadi "Memproses..."
    sendMessageButton.disabled = true;
    sendMessageButton.innerHTML =
      '<i class="fa fa-spinner fa-spin"></i> Memproses...';

    $.ajax({
      url: "/bot/message",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        apiKey: apiKey,
        deviceKey: deviceKey,
        to: to,
        text: text,
        isGroup: group,
      }),
      success: function (response) {
        showToast(response.message, "success");
        console.log("Pesan berhasil dikirim:", response);
        $("#to").val("");
        $("#text").val("");
        // Filter pesan berdasarkan status tab yang aktif
        filterPesan();
      },
      error: function (xhr, status, error) {
        showToast("Terjadi kesalahan saat mengirim pesan.", "danger");
        console.error("Gagal mengirim pesan:", xhr.responseText || error);
      },
      complete: function () {
        sendMessageButton.disabled = false;
        sendMessageButton.innerHTML = "Kirim";
      },
    });
  });

  async function confirmDelete(id) {
    if (!confirm(`Apakah Anda yakin ingin menghapus pesan ${id}?`)) return;
    const apiKey = document.getElementById("apiKey").value;
    try {
      const response = await fetch(
        `/client/message/remove?apiKey=${encodeURIComponent(
          apiKey
        )}&id=${encodeURIComponent(id)}`,
        {
          method: "DELETE",
        }
      );
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      const result = await response.json();
      if (result.status) {
        showToast("Pesan berhasil dihapus!", "success");

        // Ambil status tab yang aktif
        const activeTab = document.querySelector(".nav-tabs .nav-link.active");
        const activeStatus = activeTab
          ? activeTab.getAttribute("data-status")
          : "all";

        // Filter pesan berdasarkan status tab yang aktif
        filterPesan(activeStatus);
      } else {
        throw new Error(result.message || "Gagal menghapus pesan");
      }
    } catch (error) {
      console.error("Error:", error);

      showToast(`Error: ${error.message}`, "danger");
    }
  }

  async function confirmRetry(id) {
    if (!confirm(`Apakah Anda yakin ingin retry pesan ${id}?`)) return;
    const apiKey = document.getElementById("apiKey").value;
    try {
      const response = await fetch(
        `/client/message/retry?apiKey=${encodeURIComponent(
          apiKey
        )}&id=${encodeURIComponent(id)}`,
        {
          method: "POST",
        }
      );
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      const result = await response.json();
      if (result.status) {
        showToast("Pesan berhasil diretry!", "success");

        // Ambil status tab yang aktif
        const activeTab = document.querySelector(".nav-tabs .nav-link.active");
        const activeStatus = activeTab
          ? activeTab.getAttribute("data-status")
          : "all";

        // Filter pesan berdasarkan status tab yang aktif
        filterPesan(activeStatus);
      } else {
        throw new Error(result.message || "Gagal retry pesan");
      }
    } catch (error) {
      console.error("Error:", error);
      showToast(`Error: ${error.message}`, "danger");
    }
  }

  // Hentikan interval saat halaman ditutup atau tidak digunakan lagi
  window.addEventListener("beforeunload", function () {
    clearInterval(refreshInterval);
  });
</script>

<!-- HTML untuk Judul Daftar Pesan -->
<div style="display: flex; justify-content: flex-start; align-items: center">
  <label style="margin-left: 15px">
    <input
      type="checkbox"
      id="autoRefreshCheckbox"
      onchange="toggleAutoRefresh()"
      checked
    />
    Auto Refresh
  </label>
</div>
